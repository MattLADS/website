<div id="dm-container">
    <h2>Direct Messages</h2>
    <div id="user-list"></div>
    <div id="chat-window">
        <div id="chat-history"></div>
        <input type="text" id="message-input" placeholder="Type a message..." />
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<script>
			async function fetchUsers() {
			    try {
			        const response = await fetch('/fetch-users');
			        if (!response.ok) {
			            throw new Error(`Failed to fetch users: ${response.statusText}`);
			        }
			
			        const users = await response.json();
			        const userList = document.getElementById('users'); // Matches the `<ul id="users">` in HTML
			
			        if (users.length === 0) {
			            userList.innerHTML = '<li>No users available</li>';
			            return;
			        }
			
			        // Populate users list
			        userList.innerHTML = users
			            .map(user => `<li onclick="selectUser('${user.Username}')">${user.Username}</li>`)
			            .join('');
			    } catch (error) {
			        console.error(error.message);
			    }
			}
			
			async function fetchMessages(recipient) {
			    console.log(`Fetching messages for recipient: ${recipient}`); // Debugging
			    try {
			        const response = await fetch(`/get-messages?recipient=${encodeURIComponent(recipient)}`);
			        if (!response.ok) {
			            console.error('Failed to fetch messages:', await response.text());
			            return;
			        }
			
			        const messages = await response.json();
			        const chatHistory = document.getElementById('chat-history');
			
			        // Populate chat history
			        chatHistory.innerHTML = messages
			            .map(msg => `<p class="chat-message"><strong>${msg.Sender}:</strong> ${msg.Content}</p>`)
			            .join('');
			
			        // Scroll to the bottom
			        chatHistory.scrollTop = chatHistory.scrollHeight;
			    } catch (error) {
			        console.error('Error fetching messages:', error);
			    }
			}
			
		let chatPollingInterval;
		
		function startChatPolling(recipient) {
		    if (chatPollingInterval) clearInterval(chatPollingInterval);
		
		    chatPollingInterval = setInterval(() => {
		        fetchMessages(recipient);
		    }, 3000); // Poll every 3 seconds
		}
		
		function selectUser(username) {
		    // Clear previous selection
		    document.querySelectorAll('#users li').forEach(li => li.classList.remove('selected'));
		
		    // Highlight selected user
		    const selectedUser = Array.from(document.querySelectorAll('#users li')).find(
		        li => li.textContent.trim() === username
		    );
		    if (selectedUser) {
		        selectedUser.classList.add('selected');
		    }
		
		    // Fetch messages and start polling
		    fetchMessages(username);
		    startChatPolling(username);
		}
		
			   async function sendMessage() {
			       const messageInput = document.getElementById('message-input');
			       const content = messageInput.value.trim();
			       const recipient = document.querySelector('#users li.selected')?.textContent;
			   
			       if (!recipient || !content) {
			           alert('Select a user and type a message.');
			           return;
			       }
			   
			       try {
			           const response = await fetch('/send-message', {
			               method: 'POST',
			               headers: { 'Content-Type': 'application/json' },
			               body: JSON.stringify({ recipient, content }),
			           });
			   
			           if (!response.ok) {
			               console.error('Failed to send message:', await response.text());
			               alert('Failed to send message.');
			               return;
			           }
			   
			           // Clear the input box
			           messageInput.value = '';
			   
			           // Append the message to the chat history immediately
			           const chatHistory = document.getElementById('chat-history');
			           const newMessage = document.createElement('p');
			           newMessage.classList.add('chat-message');
			           newMessage.innerHTML = `<strong>You:</strong> ${content}`;
			           chatHistory.appendChild(newMessage);
			   
			           // Scroll to the bottom of the chat history
			           chatHistory.scrollTop = chatHistory.scrollHeight;
			       } catch (error) {
			           console.error('Error sending message:', error);
			       }
			   }

			   async function fetchUnreadCounts() {
			       try {
			           const response = await fetch('/fetch-unread-counts');
			           if (!response.ok) return;
			   
			           const unreadCounts = await response.json();
			           unreadCounts.forEach(user => {
			               const userElement = document.querySelector(`#users li[data-username="${user.username}"]`);
			               if (userElement) {
			                   const badge = userElement.querySelector('.badge') || document.createElement('span');
			                   badge.className = 'badge';
			                   badge.textContent = user.unreadCount;
			                   userElement.appendChild(badge);
			               }
			           });
			       } catch (error) {
			           console.error('Error fetching unread counts:', error);
			       }
			   }
			   							
		    document.addEventListener('click', function (e) {
		        if (e.target.closest('#users li')) {
		            selectUser(e.target.textContent.trim());
		        }
		    });
</script>
